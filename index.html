<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Split App</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; }
.container { max-width:1000px; margin:auto; background:white; padding:20px; margin-top:25px; border-radius:8px }
input, select, button { width:100%; padding:8px; margin-top:6px }
button { background:#2563eb; color:white; border:none; cursor:pointer }
button:hover { background:#1e40af }
.hidden { display:none }
table { width:100%; border-collapse:collapse; margin-top:15px }
th, td { border:1px solid #ccc; padding:8px; text-align:center }
.info { background:#eef; padding:10px; border-radius:6px }
.audit { font-size:13px; color:#555 }
.logout { background:#999 }
.member-tag { display:inline-block; background:#ddd; padding:4px 8px; margin:3px; border-radius:4px }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h2>Login</h2>
  <input id="userName" placeholder="Your Name">
  <input id="userEmail" placeholder="Your Email">
  <button onclick="login()">Login</button>
</div>

<!-- GROUP -->
<div class="container hidden" id="groupBox">
  <h2>Create / Join Trip</h2>
  <input id="groupName" placeholder="Trip / Group Name">
  <button onclick="createGroup()">Create Group</button>
  <hr>
  <input id="inviteInput" placeholder="Paste Invite Link">
  <button onclick="joinGroup()">Join Group</button>
</div>

<!-- APP -->
<div class="container hidden" id="appBox">
  <button class="logout" onclick="logout()">Logout</button>

  <div class="info">
    <p><b>Group:</b> <span id="groupTitle"></span></p>
    <p><b>Logged in:</b> <span id="loggedUser"></span></p>
    <p><b>Invite Link:</b></p>
    <input id="inviteLink" readonly>
  </div>

  <!-- MEMBERS -->
  <h3>Group Members</h3>
  <input id="newMember" placeholder="Add member name">
  <button onclick="addMember()">Add Member</button>
  <div id="memberList"></div>

  <!-- EXPENSE -->
  <h3>Add Expense</h3>
  <select id="spentBy"></select>
  <input id="amount" placeholder="Amount">
  <input id="place" placeholder="Where spent">
  <input id="reason" placeholder="Reason / For what">
  <input type="date" id="date">
  <button onclick="addExpense()">Add Expense</button>

  <!-- HISTORY -->
  <h3>Expense History</h3>
  <table>
    <thead>
      <tr>
        <th>Spent By</th>
        <th>Entered By</th>
        <th>Amount</th>
        <th>Where</th>
        <th>Reason</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="expenseTable"></tbody>
  </table>

  <!-- SUMMARY -->
  <h3>Settlement Summary</h3>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Total Paid</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody id="summaryTable"></tbody>
  </table>

  <button style="background:#16a34a;margin-top:15px" onclick="downloadPDF()">
    End Split & Download Report
  </button>

  <h3>Audit Trail</h3>
  <div class="audit" id="auditLog"></div>
</div>

<script>
let currentUser = null;
let currentGroupId = null;
let groups = JSON.parse(localStorage.getItem("groups")) || {};

/* LOGIN */
function login() {
  if (!userName.value || !userEmail.value) return alert("Enter name and email");
  currentUser = { name: userName.value, email: userEmail.value };
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  loginBox.classList.add("hidden");
  groupBox.classList.remove("hidden");
}

/* GROUP */
function createGroup() {
  currentGroupId = "grp_" + Date.now();
  groups[currentGroupId] = {
    name: groupName.value,
    members: [currentUser.name],
    expenses: [],
    audit: []
  };
  save(); openGroup();
}

function joinGroup() {
  const id = new URL(inviteInput.value).searchParams.get("group");
  if (!groups[id]) {
    groups[id] = { name:"Joined Group", members:[currentUser.name], expenses:[], audit:[] };
  }
  currentGroupId = id; save(); openGroup();
}

function openGroup() {
  groupBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  groupTitle.innerText = groups[currentGroupId].name;
  loggedUser.innerText = currentUser.name;
  inviteLink.value = location.origin + location.pathname + "?group=" + currentGroupId;

  refreshMembers();
  render();
}

/* MEMBERS */
function addMember() {
  const name = newMember.value.trim();
  if (!name) return;
  if (!groups[currentGroupId].members.includes(name)) {
    groups[currentGroupId].members.push(name);
    groups[currentGroupId].audit.push(
      `${new Date().toLocaleString()} – ${currentUser.name} added member ${name}`
    );
  }
  newMember.value = "";
  save(); refreshMembers(); render();
}

function refreshMembers() {
  memberList.innerHTML = "";
  spentBy.innerHTML = "";

  groups[currentGroupId].members.forEach(m => {
    memberList.innerHTML += `<span class="member-tag">${m}</span>`;
    spentBy.innerHTML += `<option>${m}</option>`;
  });
}

/* EXPENSE */
function addExpense() {
  if (!amount.value || !place.value || !reason.value || !date.value)
    return alert("Fill all fields");

  groups[currentGroupId].expenses.push({
    spentBy: spentBy.value,
    enteredBy: currentUser.name,
    amount: Number(amount.value),
    where: place.value,
    reason: reason.value,
    date: date.value
  });

  groups[currentGroupId].audit.push(
    `${new Date().toLocaleString()} – ${currentUser.name} added ₹${amount.value} spent by ${spentBy.value}`
  );

  save(); render();
}

/* RENDER */
function render() {
  expenseTable.innerHTML = "";
  auditLog.innerHTML = "";

  let paid = {};
  groups[currentGroupId].members.forEach(m => paid[m] = 0);

  groups[currentGroupId].expenses.forEach(e => {
    expenseTable.innerHTML += `
      <tr>
        <td>${e.spentBy}</td>
        <td>${e.enteredBy}</td>
        <td>₹${e.amount}</td>
        <td>${e.where}</td>
        <td>${e.reason}</td>
        <td>${e.date}</td>
      </tr>`;
    paid[e.spentBy] += e.amount;
  });

  const total = Object.values(paid).reduce((a,b)=>a+b,0);
  const share = total / groups[currentGroupId].members.length;

  summaryTable.innerHTML = "";
  Object.keys(paid).forEach(u => {
    const bal = paid[u] - share;
    summaryTable.innerHTML += `
      <tr>
        <td>${u}</td>
        <td>₹${paid[u]}</td>
        <td>${bal>=0?"Gets":"Owes"} ₹${Math.abs(bal).toFixed(2)}</td>
      </tr>`;
  });

  groups[currentGroupId].audit.forEach(a => auditLog.innerHTML += a + "<br>");
}

/* PDF */
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Expense Split Report",10,10);
  pdf.text("Group: " + groups[currentGroupId].name,10,20);
  pdf.save("expense-split-report.pdf");
}

/* INIT */
const savedUser = JSON.parse(localStorage.getItem("currentUser"));
const params = new URLSearchParams(location.search);
if (savedUser) { currentUser = savedUser; loginBox.classList.add("hidden"); groupBox.classList.remove("hidden"); }
if (params.get("group")) {
  currentGroupId = params.get("group");
  if (!groups[currentGroupId]) {
    groups[currentGroupId] = { name:"Shared Group", members:[currentUser.name], expenses:[], audit:[] };
  }
  save(); openGroup();
}

function save() {
  localStorage.setItem("groups", JSON.stringify(groups));
}
</script>

</body>
</html>
