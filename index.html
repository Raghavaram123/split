<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Split App</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8 }
.container { max-width:1000px; margin:auto; background:white; padding:20px; margin-top:25px; border-radius:8px }
input, button { width:100%; padding:8px; margin-top:6px }
button { background:#2563eb; color:white; border:none; cursor:pointer }
button:hover { background:#1e40af }
.hidden { display:none }
table { width:100%; border-collapse:collapse; margin-top:15px }
th, td { border:1px solid #ccc; padding:8px; text-align:center }
.audit { font-size:13px; color:#555 }
.logout { background:#999; float:right }
.info { background:#eef; padding:10px; border-radius:6px }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h2>Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login / Register</button>
</div>

<!-- GROUP -->
<div class="container hidden" id="groupBox">
  <h2>Create or Join Group</h2>
  <input id="groupName" placeholder="New Group Name">
  <button onclick="createGroup()">Create Group</button>
  <hr>
  <input id="inviteCode" placeholder="Invite Code">
  <button onclick="joinGroup()">Join Group</button>
</div>

<!-- APP -->
<div class="container hidden" id="appBox">
  <button class="logout" onclick="logout()">Logout</button>

  <div class="info">
    <p><b>Logged in as:</b> <span id="userEmail"></span></p>
    <p><b>Group name:</b> <span id="groupTitle"></span></p>
  </div>

  <h3>Add Expense</h3>
  <input id="amount" placeholder="Amount">
  <input id="place" placeholder="Where spent">
  <input id="reason" placeholder="Reason / Purpose">
  <input type="date" id="date">
  <button onclick="addExpense()">Add Expense</button>

  <h3>Expense History</h3>
  <table>
    <thead>
      <tr>
        <th>Who</th>
        <th>Amount</th>
        <th>Where</th>
        <th>Reason</th>
        <th>Date</th>
        <th>Added At</th>
      </tr>
    </thead>
    <tbody id="expenseTable"></tbody>
  </table>

  <h3>Settlement Summary</h3>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Total Paid</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody id="summaryTable"></tbody>
  </table>

  <button style="background:#16a34a;margin-top:15px" onclick="downloadPDF()">
    End Split & Download Detailed PDF
  </button>

  <h3>Audit Trail</h3>
  <div class="audit" id="auditLog"></div>
</div>

<script>
/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyD8ageJ9iu3tGyS4-9VZD2D7wPXoU9Epxc",
  authDomain: "split-a4ba5.firebaseapp.com",
  projectId: "split-a4ba5",
  storageBucket: "split-a4ba5.firebasestorage.app",
  messagingSenderId: "511024932142",
  appId: "1:511024932142:web:936a3c580ca3616854c6bf"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentGroupId = null;

/* ================= AUTH ================= */

auth.onAuthStateChanged(user => {
  loginBox.classList.add("hidden");
  groupBox.classList.add("hidden");
  appBox.classList.add("hidden");

  if (!user) {
    loginBox.classList.remove("hidden");
  } else {
    currentUser = user.email;
    userEmail.innerText = currentUser;
    groupBox.classList.remove("hidden");
  }
});

function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(() => auth.createUserWithEmailAndPassword(email.value, password.value));
}

function logout() {
  auth.signOut();
}

/* ================= GROUP ================= */

function createGroup() {
  const id = Math.random().toString(36).substring(2,8);
  db.collection("groups").doc(id).set({
    name: groupName.value,
    members: [currentUser],
    createdAt: new Date()
  }).then(() => openGroup(id));
}

function joinGroup() {
  openGroup(inviteCode.value);
}

function openGroup(id) {
  currentGroupId = id;
  groupBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  const ref = db.collection("groups").doc(id);

  ref.update({
    members: firebase.firestore.FieldValue.arrayUnion(currentUser)
  });

  ref.onSnapshot(doc => {
    if (doc.exists) {
      groupTitle.innerText = doc.data().name;
    }
  });

  loadExpenses();
}

/* ================= EXPENSE ================= */

function addExpense() {
  if (!amount.value || !place.value || !reason.value || !date.value)
    return alert("Fill all fields");

  db.collection("groups").doc(currentGroupId)
    .collection("expenses")
    .add({
      who: currentUser,
      amount: Number(amount.value),
      where: place.value,
      reason: reason.value,
      spentOn: date.value,
      createdAt: new Date()
    });

  db.collection("groups").doc(currentGroupId)
    .collection("audit")
    .add({
      text: `${currentUser} added ₹${amount.value} for ${reason.value}`,
      time: new Date()
    });

  amount.value = place.value = reason.value = "";
}

function loadExpenses() {
  const expRef = db.collection("groups").doc(currentGroupId).collection("expenses");
  const auditRef = db.collection("groups").doc(currentGroupId).collection("audit");

  expRef.onSnapshot(snap => {
    expenseTable.innerHTML = "";
    let paid = {};
    let users = [];

    snap.forEach(doc => {
      const e = doc.data();
      expenseTable.innerHTML += `
        <tr>
          <td>${e.who}</td>
          <td>₹${e.amount}</td>
          <td>${e.where}</td>
          <td>${e.reason}</td>
          <td>${e.spentOn}</td>
          <td>${e.createdAt.toDate().toLocaleString()}</td>
        </tr>`;
      paid[e.who] = (paid[e.who] || 0) + e.amount;
      if (!users.includes(e.who)) users.push(e.who);
    });

    const total = Object.values(paid).reduce((a,b)=>a+b,0);
    const share = users.length ? total / users.length : 0;

    summaryTable.innerHTML = "";
    users.forEach(u => {
      const bal = paid[u] - share;
      summaryTable.innerHTML += `
        <tr>
          <td>${u}</td>
          <td>₹${paid[u]}</td>
          <td>${bal >= 0 ? "Gets" : "Owes"} ₹${Math.abs(bal).toFixed(2)}</td>
        </tr>`;
    });
  });

  auditRef.onSnapshot(snap => {
    auditLog.innerHTML = "";
    snap.forEach(doc => {
      auditLog.innerHTML += doc.data().text + "<br>";
    });
  });
}

/* ================= PDF ================= */

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Expense Split Detailed Report", 10, 10);
  pdf.text("Group: " + groupTitle.innerText, 10, 20);
  pdf.text("Generated by: " + currentUser, 10, 30);
  pdf.save("expense-split-detailed-report.pdf");
}
</script>

</body>
</html>
